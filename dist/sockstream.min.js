"use strict";function _toConsumableArray(e){if(Array.isArray(e)){for(var t=0,n=Array(e.length);t<e.length;t++)n[t]=e[t];return n}return Array.from(e)}function _classCallCheck(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}Object.defineProperty(exports,"__esModule",{value:!0});var _typeof="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e},_createClass=function(){function e(e,t){for(var n=0;n<t.length;n++){var o=t[n];o.enumerable=o.enumerable||!1,o.configurable=!0,"value"in o&&(o.writable=!0),Object.defineProperty(e,o.key,o)}}return function(t,n,o){return n&&e(t.prototype,n),o&&e(t,o),t}}(),StreamSock=function(){function e(){var t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:"localhost",n=arguments.length>1&&void 0!==arguments[1]?arguments[1]:8082,o=!(arguments.length>2&&void 0!==arguments[2])||arguments[2],i=this,s=arguments.length>3&&void 0!==arguments[3]?arguments[3]:800,r=arguments.length>4&&void 0!==arguments[4]?arguments[4]:0;_classCallCheck(this,e);var c="sockstream.js",a="1.3.3",l=800,f=0,u=8082,p="wss://",g="127.0.0.1";this.callbackRegister={ping:function(e){i.send("pong"),i.console(["[PING]",e])},system:function(e){i.console(["[SYSTEM]",e])}},this.maxKeepAliveAttempt=20,this.keepAliveAttempt=0,this.disconnect=[],this.connections={},this._config={client:{name:c,version:a,debugLevel:f,keepAlive:l},server:{hostname:g,port:u,proto:p}},"object"===("undefined"==typeof t?"undefined":_typeof(t))?("object"===_typeof(t.client)&&(this._config.client=Object.assign({debugLevel:f,keepAlive:l},t.client,{name:c,version:a})),"object"===_typeof(t.server)&&(this._config.server=Object.assign({hostname:g,port:u,proto:p},t.server))):this._config={client:{name:c,version:a,debugLevel:r,keepAlive:s},server:{hostname:t,port:n,proto:o?"wss://":"ws://"}}}return _createClass(e,[{key:"console",value:function(e){function t(t){return e.apply(this,arguments)}return t.toString=function(){return e.toString()},t}(function(e){var t,n=arguments.length>1&&void 0!==arguments[1]?arguments[1]:"log",o={log:4,debug:3,info:2,warn:1,error:0};this._config.client.debugLevel>=(o[n]||0)&&(t=console)[n].apply(t,_toConsumableArray(e))})},{key:"debug",value:function(e){return"undefined"!=typeof e&&(this._config.client.debug=!!e),this._config.client.debug}},{key:"close",value:function(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:null,t=e||this.lastConnectionId;return"undefined"!=typeof this.connections[t]&&(this.disconnect.push(t),this.connections[t].close()),!0}},{key:"send",value:function(t,n){var o=this.lastConnectionId;if("function"!=typeof n&&"undefined"!=typeof this.connections[n]&&(this.lastConnectionId=o=n),"undefined"==typeof this.connections[o])return!1;if(this.connections[o].readyState===this.connections[o].OPEN){var i=e.generateUUID();return"function"==typeof n&&(this.callbackRegister[i]=n),this.connections[o].send(JSON.stringify({"@meta":Object.assign({_id:i},this._config),message:t})),!0}return this.console("WebSocket not open","warn"),!1}},{key:"open",value:function(t){var n=this;this.console(["[CONNECTING]",""+this._config.server.proto+this._config.server.hostname+":"+this._config.server.port],"info");var o=e.generateUUID();this.lastConnectionId=o;try{this.connections[o]=new WebSocket(""+this._config.server.proto+this._config.server.hostname+":"+this._config.server.port)}catch(e){return}return this.connections[o].readyState===this.connections[o].CONNECTING&&(this.connections[o].onopen=function(){n.console("connected","info"),n.keepAliveAttempt=0,setTimeout(function(){n.send("connecting",t)},20)},this.connections[o].onerror=function(e){n.console(e,"error")},this.connections[o].onmessage=function(t){var o=e.parseMessage(t.data);o&&"undefined"!=typeof o["@meta"]?("function"==typeof n.callbackRegister[o["@meta"]._type]?n.callbackRegister[o["@meta"]._type].call(n._config,o["@meta"]._system):"function"==typeof n.callbackRegister[o["@meta"]._id]&&(n.callbackRegister[o["@meta"]._id].call(n._config,o.message),delete n.callbackRegister[o["@meta"]._id]),n.console(["[RCVD]",o.message],"debug")):n.console(["[RCVD]",t.data],"debug")},this.connections[o].onclose=function(e){if(n.console(["WebSocket closed",e],"warn"),n.disconnect.indexOf(o)===-1&&"number"==typeof n._config.client.keepAlive&&n._config.client.keepAlive>0){if(++n.keepAliveAttempt>n.maxKeepAliveAttempt)return;var t=n._config.client.keepAlive;n.keepAliveAttempt>5?t+=t/2:n.keepAliveAttempt>10&&(t=2*t),setTimeout(function(){n.console("Attempting to reestablish WebSocket","info"),n.open()},t)}delete n.connections[o]}),o}},{key:"setMaxKeepAliveAttempt",value:function(e){return this.maxKeepAliveAttempt="number"==typeof e?e:this.maxKeepAliveAttempt,this}}],[{key:"generateUUID",value:function(){var e=(new Date).getTime();return window.performance&&"function"==typeof window.performance.now&&(e+=performance.now()),"xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx".replace(/[xy]/g,function(t){var n=(e+16*Math.random())%16|0;return e=Math.floor(e/16),("x"==t?n:3&n|8).toString(16)})}},{key:"parseMessage",value:function(e){return"undefined"==typeof e?null:"string"==typeof e?JSON.parse(e):e}}]),e}();exports.default=StreamSock;