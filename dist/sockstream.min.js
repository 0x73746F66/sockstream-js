"use strict";function _classCallCheck(e,n){if(!(e instanceof n))throw new TypeError("Cannot call a class as a function")}Object.defineProperty(exports,"__esModule",{value:!0});var _typeof="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e},_createClass=function(){function e(e,n){for(var t=0;t<n.length;t++){var o=n[t];o.enumerable=o.enumerable||!1,o.configurable=!0,"value"in o&&(o.writable=!0),Object.defineProperty(e,o.key,o)}}return function(n,t,o){return t&&e(n.prototype,t),o&&e(n,o),n}}(),StreamSock=function(){function e(){var n=arguments.length>0&&void 0!==arguments[0]?arguments[0]:"localhost",t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:8082,o=!(arguments.length>2&&void 0!==arguments[2])||arguments[2],i=this,s=arguments.length>3&&void 0!==arguments[3]?arguments[3]:800,c=arguments.length>4&&void 0!==arguments[4]?arguments[4]:0;_classCallCheck(this,e),this.callbackRegister={ping:function(e){i.send("pong"),i.console(["[PING]",e])},system:function(e){i.console(["[SYSTEM]",e])}},this.disconnect=[],this.connections={},this._config={client:{name:"sockstream.js",version:1.2,debugLevel:0,keepAlive:800},server:{name:"sockets/php-stream-socket-server",version:1.3,hostname:"localhost",port:8082,proto:"wss://"}},"object"===("undefined"==typeof n?"undefined":_typeof(n))?("object"===_typeof(n.client)&&(this._config.client=Object.assign({debugLevel:0,keepAlive:800},n.client,{name:"sockstream.js",version:.1})),"object"===_typeof(n.server)&&(this._config.server=Object.assign({hostname:"localhost",port:8082,proto:"wss://"},n.server,{name:"sockets/php-stream-socket-server",version:1.3}))):this._config={client:{name:"sockstream.js",version:.1,debugLevel:c,keepAlive:s},server:{name:"sockets/php-stream-socket-server",version:1.3,hostname:n,port:t,proto:o?"wss://":"ws://"}}}return _createClass(e,[{key:"console",value:function(e){function n(n){return e.apply(this,arguments)}return n.toString=function(){return e.toString()},n}(function(e){var n=arguments.length>1&&void 0!==arguments[1]?arguments[1]:"log",t={log:4,debug:3,info:2,warn:1,error:0};this._config.client.debugLevel>=(t[n]||0)&&console[n](e)})},{key:"debug",value:function(e){return"undefined"!=typeof e&&(this._config.client.debug=!!e),this._config.client.debug}},{key:"close",value:function(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:null,n=e||this.lastConnectionId;return"undefined"!=typeof this.connections[n]&&(this.disconnect.push(n),this.connections[n].close()),!0}},{key:"send",value:function(n,t){var o=this.lastConnectionId;if("function"!=typeof t&&"undefined"!=typeof this.connections[t]&&(this.lastConnectionId=o=t),"undefined"==typeof this.connections[o])return!1;if(this.connections[o].readyState===this.connections[o].OPEN){var i=e.generateUUID();return"function"==typeof t&&(this.callbackRegister[i]=t),this.connections[o].send(JSON.stringify({"@meta":Object.assign({_id:i},this._config),message:n})),!0}return this.console("WebSocket not open","warn"),!1}},{key:"open",value:function(n){var t=this;this.console(["[CONNECTING]",""+this._config.server.proto+this._config.server.hostname+":"+this._config.server.port],"info");var o=e.generateUUID();return this.lastConnectionId=o,this.connections[o]=new WebSocket(""+this._config.server.proto+this._config.server.hostname+":"+this._config.server.port),this.connections[o].readyState===this.connections[o].CONNECTING&&(this.connections[o].onopen=function(){t.console("connected","info"),setTimeout(function(){t.send("connecting",n)},20)},this.connections[o].onerror=function(e){t.console(["WebSocket error",e],"error")},this.connections[o].onmessage=function(n){var o=e.parseMessage(n.data);o&&"undefined"!=typeof o["@meta"]&&("function"==typeof t.callbackRegister[o["@meta"]._type]?t.callbackRegister[o["@meta"]._type].call(t._config,o["@meta"]._system):"function"==typeof t.callbackRegister[o["@meta"]._id]&&(t.callbackRegister[o["@meta"]._id].call(t._config,o.message||null),delete t.callbackRegister[o["@meta"]._id])),t.console(["[RCVD]",o],"debug")},this.connections[o].onclose=function(e){t.console(["WebSocket closed",e],"warn"),t.disconnect.indexOf(o)===-1&&"number"==typeof t._config.client.keepAlive&&t._config.client.keepAlive>0&&setTimeout(function(){t.console("Attempting to reestablish WebSocket","info"),t.open()},t._config.client.keepAlive),delete t.connections[o]}),o}}],[{key:"generateUUID",value:function(){var e=(new Date).getTime();return window.performance&&"function"==typeof window.performance.now&&(e+=performance.now()),"xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx".replace(/[xy]/g,function(n){var t=(e+16*Math.random())%16|0;return e=Math.floor(e/16),("x"==n?t:3&t|8).toString(16)})}},{key:"parseMessage",value:function(e){return"undefined"==typeof e?null:"string"==typeof e?JSON.parse(e):e}}]),e}();exports.default=StreamSock;