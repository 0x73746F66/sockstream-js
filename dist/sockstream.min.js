"use strict";function _classCallCheck(e,n){if(!(e instanceof n))throw new TypeError("Cannot call a class as a function")}Object.defineProperty(exports,"__esModule",{value:!0});var _typeof="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e},_createClass=function(){function e(e,n){for(var t=0;t<n.length;t++){var o=n[t];o.enumerable=o.enumerable||!1,o.configurable=!0,"value"in o&&(o.writable=!0),Object.defineProperty(e,o.key,o)}}return function(n,t,o){return t&&e(n.prototype,t),o&&e(n,o),n}}(),StreamSock=function(){function e(){var n=arguments.length>0&&void 0!==arguments[0]?arguments[0]:"localhost",t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:8082,o=!(arguments.length>2&&void 0!==arguments[2])||arguments[2],i=this,s=arguments.length>3&&void 0!==arguments[3]?arguments[3]:800,c=arguments.length>4&&void 0!==arguments[4]?arguments[4]:0;_classCallCheck(this,e),this.callbackRegister={ping:function(e){i.send("pong"),i.console(["[PING]",e])},system:function(e){i.console(["[SYSTEM]",e])}},this.disconnect=[],this.connections={},this._config={client:{name:"sockstream.js",version:1.3,debugLevel:0,keepAlive:800},server:{name:"sockets/php-stream-socket-server",version:1.3,hostname:"localhost",port:8082,proto:"wss://"}},"object"===("undefined"==typeof n?"undefined":_typeof(n))?("object"===_typeof(n.client)&&(this._config.client=Object.assign({debugLevel:0,keepAlive:800},n.client,{name:"sockstream.js",version:.1})),"object"===_typeof(n.server)&&(this._config.server=Object.assign({hostname:"localhost",port:8082,proto:"wss://"},n.server,{name:"sockets/php-stream-socket-server",version:1.3}))):this._config={client:{name:"sockstream.js",version:.1,debugLevel:c,keepAlive:s},server:{name:"sockets/php-stream-socket-server",version:1.3,hostname:n,port:t,proto:o?"wss://":"ws://"}}}return _createClass(e,[{key:"console",value:function(e){function n(n){return e.apply(this,arguments)}return n.toString=function(){return e.toString()},n}(function(e){var n=arguments.length>1&&void 0!==arguments[1]?arguments[1]:"log",t={log:4,debug:3,info:2,warn:1,error:0};this._config.client.debugLevel>=(t[n]||0)&&console[n](e)})},{key:"debug",value:function(e){return"undefined"!=typeof e&&(this._config.client.debug=!!e),this._config.client.debug}},{key:"close",value:function(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:null,n=e||this.lastConnectionId;return"undefined"!=typeof this.connections[n]&&(this.disconnect.push(n),this.connections[n].close()),!0}},{key:"send",value:function(e,n){var t=this.lastConnectionId;if("function"!=typeof n&&"undefined"!=typeof this.connections[n]&&(this.lastConnectionId=t=n),"undefined"==typeof this.connections[t])return!1;if(this.connections[t].readyState===this.connections[t].OPEN){var o=StreamSocketClient.generateUUID();return"function"==typeof n&&(this.callbackRegister[o]=n),this.connections[t].send(JSON.stringify({"@meta":Object.assign({_id:o},this._config),message:e})),!0}return this.console("WebSocket not open","warn"),!1}},{key:"open",value:function(e){var n=this;this.console(["[CONNECTING]",""+this._config.server.proto+this._config.server.hostname+":"+this._config.server.port],"info");var t=StreamSocketClient.generateUUID();return this.lastConnectionId=t,this.connections[t]=new WebSocket(""+this._config.server.proto+this._config.server.hostname+":"+this._config.server.port),this.connections[t].readyState===this.connections[t].CONNECTING&&(this.connections[t].onopen=function(){n.console("connected","info"),setTimeout(function(){n.send("connecting",e)},20)},this.connections[t].onerror=function(e){n.console(["WebSocket error",e],"error")},this.connections[t].onmessage=function(e){var t=StreamSocketClient.parseMessage(e.data);t&&"undefined"!=typeof t["@meta"]&&("function"==typeof n.callbackRegister[t["@meta"]._type]?n.callbackRegister[t["@meta"]._type].call(n._config,t["@meta"]._system):"function"==typeof n.callbackRegister[t["@meta"]._id]&&(n.callbackRegister[t["@meta"]._id].call(n._config,t.message||null),delete n.callbackRegister[t["@meta"]._id])),n.console(["[RCVD]",t],"debug")},this.connections[t].onclose=function(e){n.console(["WebSocket closed",e],"warn"),n.disconnect.indexOf(t)===-1&&"number"==typeof n._config.client.keepAlive&&n._config.client.keepAlive>0&&setTimeout(function(){n.console("Attempting to reestablish WebSocket","info"),n.open()},n._config.client.keepAlive),delete n.connections[t]}),t}}],[{key:"generateUUID",value:function(){var e=(new Date).getTime();return window.performance&&"function"==typeof window.performance.now&&(e+=performance.now()),"xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx".replace(/[xy]/g,function(n){var t=(e+16*Math.random())%16|0;return e=Math.floor(e/16),("x"==n?t:3&t|8).toString(16)})}},{key:"parseMessage",value:function(e){return"undefined"==typeof e?null:"string"==typeof e?JSON.parse(e):e}}]),e}();exports.default=StreamSock;